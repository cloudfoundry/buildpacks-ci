---
resource_types:
  - name: google-cloud-storage
    type: docker-image
    source:
      repository: frodenas/gcs-resource

resources:
  - name: buildpacks-ci
    type: git
    source:
      uri: {{buildpacks-ci-git-uri-public}}
      branch: master

  - name: nodejs-cnb
    type: git
    source:
      uri: git@github.com:cloudfoundry/nodejs-cnb.git
      private_key: {{cf-buildpacks-eng-github-ssh-key}}
      branch: master

  - name: npm-cnb
    type: git
    source:
      uri: git@github.com:cloudfoundry/npm-cnb.git
      private_key: {{cf-buildpacks-eng-github-ssh-key}}
      branch: master

  - name: yarn-cnb
    type: git
    source:
      uri: git@github.com:cloudfoundry/yarn-cnb.git
      private_key: {{cf-buildpacks-eng-github-ssh-key}}
      branch: master

  - name: version
    type: semver
    source:
      initial_version: 0.0.1
      bucket: cnb-versions
      key: builder/cflinuxfs3
      access_key_id: {{pivotal-offline-buildpacks-s3-access-key}}
      secret_access_key: {{pivotal-offline-buildpacks-s3-secret-key}}

  - name: builder-image
    type: docker-image
    source:
      repository: cfbuildpacks/node-cnb-builder
      email: {{buildpacks-docker-user-email}}
      username: {{buildpacks-docker-user-username}}
      password: {{buildpacks-docker-user-password}}

#  - name: lifecycle
#    type: google-cloud-storage
#    source:
#      bucket: cloud-native-buildpacks-lifecycle-binaries/development/lifecycle-binaries-latest.tgz

#  - name: pack
#    type: git
#    source:
#      uri: git@github.com:cloudfoundry/pack
#      branch: master
jobs:
  - name: update-builder-image
    plan:
      - aggregate:
        - get: buildpacks-ci
        - get: nodejs-cnb
          trigger: true
        - get: npm-cnb
          trigger: true
        - get: yarn-cnb
          trigger: true
#        - get: lifecycle
#          trigger: true
#        - get: pack
#          trigger: true
        - get: version
          params: { bump: patch }
      - task: update-builder-image
        file: buildpacks-ci/tasks/update-builder-image/task.yml
        privileged: true
      - put: builder-image
        params:
          load_file: docker-artifacts/builder.tgz
          load_repository: cloudfoundry/cnb
          tag_file: version/version
          tag_prefix: "cflinuxfs3-v"
          tag_as_latest: true
          get_params: {skip_download: true}
      - put: version
        params:
          file: version/version