<% cnb_images = %w(run build) %>
<% buildpacks = {
  'npm' => {
    'integration' => true
  },
  'yarn' => {
    'integration' => true
  },
  'httpd' => {
    'integration' => true
  },
  'nodejs' => {

  },
  'python' => {

  },
  'ruby' => {

  },
  'php' => {

  },
  'php-web' => {
    'integration' => true
  },
  'pip' => {
    'integration' => true
  }
}
%>
---
resource_types:
  - name: slack-notification
    type: docker-image
    source:
      repository: cfcommunity/slack-notification-resource

resources: ############################################################################################################
  ## Git ##
  - name: buildpack-git
    type: git
    webhook_token: ob0aigh3
    source:
      uri: git@github.com:<%= organization %>/<%= language %>-cnb.git
      private_key: {{cf-buildpacks-eng-github-ssh-key}}
      branch: master

  - name: buildpacks-ci
    type: git
    source:
      uri: {{buildpacks-ci-git-uri-public}}
      branch: master

  - name: cnb-scripts-git
    type: git
    source:
      uri: https://github.com/cloudfoundry/cnb-scripts
      branch: master

  ## Github Releases ##
<% if buildpacks[language]['integration'] %>
  - name: pack
    type: github-release
    source:
      repository: pack
      user: buildpack
      access_token: {{buildpacks-github-token}}
<% end %>

  - name: buildpack-github-release
    type: github-release
    source:
      repository: <%=language%>-cnb
      user: cloudfoundry
      access_token: {{buildpacks-github-token}}

  ## Docker Images ##
<% cnb_images.each do |image_type| %>
  - name: cnb-<%= image_type %>-image
    type: docker-image
    source:
      repository: cfbuildpacks/cflinuxfs3-cnb-experimental
      tag: <%= image_type %>
      email: {{buildpacks-docker-user-email}}
      username: {{buildpacks-docker-user-username}}
      password: {{buildpacks-docker-user-password}}
<% end %>

jobs: ################################################################################################################
  - name: update-scripts
    serial: true
    plan:
      - aggregate:
        - get: buildpacks-ci
        - get: buildpack
          resource: buildpack-git
        - get: cnb-scripts
          resource: cnb-scripts-git
          trigger: true
      - task: update-scripts
        file: buildpacks-ci/tasks/update-cnb-scripts/task.yml
      - put: buildpack
        resource: buildpack-git
        params:
          repository: updated-buildpack
          rebase: true

  - name: specs-unit
    serial: true
    plan:
      - do:
        - aggregate:
          - get: buildpacks-ci
          - get: buildpack
            resource: buildpack-git
            trigger: true
  <% cnb_images.each do |image_type| %>
          - get: cnb-<%= image_type %>-image
            trigger: true
            params:
              skip_download: true
  <% end %>
        - do:
          - task: unit tests
            file: buildpacks-ci/tasks/run-bp-v3-unit/task.yml

<% if buildpacks[language]['integration'] %>
  - name: specs-integration
    serial: true
    plan:
      - aggregate:
        - get: buildpacks-ci
        - get: pack
          trigger: true
        - get: buildpack
          resource: buildpack-git
          trigger: true
          passed:
          - specs-unit
<% cnb_images.each do |image_type| %>
        - get: cnb-<%= image_type %>-image
          params:
            skip_download: true
<% end %>
      - task: integration tests
        file: buildpacks-ci/tasks/run-bp-v3-integration/task.yml
        privileged: true
<% end %>

  - name: ship-it
    serial: true
    plan:
      - aggregate:
        - get: buildpacks-ci
        - get: buildpack
          resource: buildpack-git
          passed:
          - specs-unit
  <% if buildpacks[language]['integration'] %>
          - specs-integration
  <% end %>
      - task: ship-buildpack
        file: buildpacks-ci/tasks/ship-v3-buildpack/task.yml
        params:
          LANGUAGE: <%= language %>
          GITHUB_USERNAME: {{github-username}}
          GITHUB_PASSWORD: {{github-password}}
      - put: buildpack-github-release
        params:
          name: release-artifacts/name
          tag: release-artifacts/tag
          body: release-artifacts/body
          globs:
          - release-artifacts/<%= language %>-cnb-*.tgz
