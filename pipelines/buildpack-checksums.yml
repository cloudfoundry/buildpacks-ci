---
resources:
  - name: master
    type: git
    source:
      uri: git@github.com:pivotal-cf-experimental/buildpack-checksums.git
      private_key: {{buildpack-checksums-private-key}}
      branch: master
  - name: gh-pages
    type: git
    source:
      uri: git@github.com:pivotal-cf-experimental/buildpack-checksums.git
      private_key: {{buildpack-checksums-private-key}}
      branch: gh-pages

  - name: deploy-buildpack-verify
    type: cf
    source:
      api: https://api.run.pivotal.io
      username: {{pws-username}}
      password: {{pws-password}}
      organization: {{pws-org}}
      space: {{pws-space}}
      skip_cert_check: false

jobs:
  - name: build-site
    plan:
      - aggregate:
        - get: master
          trigger: true
        - get: gh-pages
      - task: run-tests
        config:
          platform: linux
          image: docker:///cfbuildpacks/ci
          inputs:
            - name: master
          run:
            path: bash
            args:
              - -c
              - |
                set -ex
                cd master
                gem install bundle
                bundle
                bundle exec rspec

      - task: build-site
        config:
          platform: linux
          image: docker:///cfbuildpacks/ci
          inputs:
            - name: master
            - name: gh-pages
          outputs:
            - name: gh-pages-artifacts
          run:
            path: bash
            args:
              - -c
              - |
                set -ex
                pushd master
                  gem install bundler
                  bundle
                  bundle exec ./generate.rb ../gh-pages
                popd

                pushd gh-pages
                  git add -A
                  git commit -m 'Update site'
                popd

                rsync -a gh-pages/ gh-pages-artifacts
        privileged: true

      - put: gh-pages
        params:
          repository: gh-pages-artifacts
          rebase: true

      - put: deploy-buildpack-verify
        params:
          path: gh-pages-artifacts
          manifest: gh-pages-artifacts/manifest.yml
