name: 'Find new CVEs'
description: |
  Check if there is a new CVE per each dependency

inputs:
  db-uri:
    description: Database URI
    required: true
  webhook-url:
    description: Slack Webhook URL
    required: true
  nvd-nist-api-key:
    description: NVD Nist API Key
    required: true

outputs:
  new-cves:
    description: If there is a new CVE or not
    value: ${{ steps.find-new-cves.outputs.new-cves }}

runs:
  using: 'composite'
  steps:
    - id: find-new-cves
      shell: bash
      run: |
        #!/usr/bin/env bash
        set -euo pipefail

        cd "${{ github.action_path }}/entrypoint"

        go build -o ./entrypoint

        ./entrypoint \
          --db-uri "${{ inputs.db-uri }}" \
          --webhook-url "${{ inputs.webhook-url }}" \
          --json-filepath "${{ github.workspace }}/cve-notification-app/cves.json" \
          --log-filepath "${{ github.workspace }}/cve-notification-app/find_new_cves.log" \
          --nvd-nist-api-key "${{ inputs.nvd-nist-api-key }}"
        
        if [ -f "${{ github.workspace }}/cve-notification-app/new-cves.json" ]; then
          new_cves="true"
        else
          new_cves="false"
        fi
        
        echo "new-cves=$new_cves" >> $GITHUB_ENV

        rm -f ./entrypoint
