# encoding: utf-8
require 'spec_helper'
require_relative '../../../lib/notifiers/cve-email-preparer-and-github-issue-notifier'

describe CVEEmailPreparerAndGithubIssueNotifier do
  let(:first_cve) do
    {
      'title' => 'USN-2875-1: libxml2 vulnerabilities',
      'description' => 'CVE Description 1',
      'raw_description' => '<p>CVE Description 1</p>'
    }
  end
  let(:second_cve) do
    {
      'title' => 'USN-2874-1: Bind vulnerability',
      'description' => 'CVE Description 2',
      'raw_description' => '<p>CVE Description 2</p>'
    }
  end
  let(:cves) { [first_cve, second_cve] }
  let(:write_directory) { './output_directory' }
  let(:contents) { { :category => 'category'} }
  let(:cloudfoundry_first_issue_response) { { html_url: 'https://github.com/cloudfoundry/security-notices/issues/111111' } }
  let(:cloudfoundry_second_issue_response) { { html_url: 'https://github.com/cloudfoundry/security-notices/issues/333333' } }

  before do
    @old_email_preparer_dir = ENV.fetch('EMAIL_PREPARER_DIR', nil)

    ENV.store('EMAIL_PREPARER_DIR', write_directory)

    allow(Octokit).to receive(:auto_paginate=)
    allow(Octokit).to receive(:configure)
    allow(Octokit).to receive(:create_issue)
    allow(Octokit).to receive(:create_issue).with('cloudfoundry/security-notices',
                                                  first_cve['title'],
                                                  "```\n#{first_cve['description']}\n```",
                                                  labels: kind_of(Array)).and_return(cloudfoundry_first_issue_response)
    allow(Octokit).to receive(:create_issue).with('cloudfoundry/security-notices',
                                                  second_cve['title'],
                                                  "```\n#{second_cve['description']}\n```",
                                                  labels: kind_of(Array)).and_return(cloudfoundry_second_issue_response)
  end

  after do
    ENV.store('EMAIL_PREPARER_DIR', @old_email_preparer_dir)

    FileUtils.rm_rf(write_directory)
  end

  subject { described_class.notify! cves, contents }

  describe '#notify!' do
    context 'has no cves' do
      let(:cves) { [] }

      context 'that are related to stacks' do
        let(:contents) { { :category => 'cflinuxfs2-related' } }

        it 'creates an empty body file' do
          subject
          expect(File.read(File.join(write_directory, 'body-cflinuxfs2-related'))).to eq('')
        end
      end

      context 'that are unrelated to stacks' do
        let(:contents) { { :category => 'cflinuxfs2-unrelated' } }

        it 'creates an empty body file' do
          subject
          expect(File.read(File.join(write_directory, 'body-cflinuxfs2-unrelated'))).to eq('')
        end
      end

      context 'that affect a buildpack' do
        let(:contents) { { :category => 'buildpack-ruby' } }

        it 'creates an empty body file' do
          subject
          expect(File.read(File.join(write_directory, 'body-buildpack-ruby'))).to eq('')
        end
      end

      it 'does not post a github issue' do
        expect(Octokit).to_not receive(:create_issue)
        subject
      end
    end

    context 'has cves' do
      context 'that are related to stacks' do
        let(:contents) { { :category => 'cflinuxfs2-related', :labels => [] } }

        it 'prepares the headers of an email with multiple cves' do
          subject

          headers_content = File.read(File.join(write_directory, 'headers-cflinuxfs2-related'))
          expect(headers_content).to eq(<<~BODY)
            MIME-version: 1.0
            Content-Type: text/html; charset="UTF-8"
          BODY
        end

        it 'prepares the subject of an email with multiple cves' do
          subject

          subject_content = File.read(File.join(write_directory, 'subject-cflinuxfs2-related'))
          expect(subject_content).to eq('New CVEs: USN-2875-1: libxml2 vulnerabilities, USN-2874-1: Bind vulnerability')
        end

        it 'prepares the body of an email with multiple cves and their newly created github issues' do
          subject

          body_content = File.read(File.join(write_directory, 'body-cflinuxfs2-related'))
          expect(body_content).to eq(<<~BODY)
            <h1>USN-2875-1: libxml2 vulnerabilities</h1>
            <h2><b>Present</b> in rootfs</h2>
            <a href='https://github.com/cloudfoundry/security-notices/issues/111111'>https://github.com/cloudfoundry/security-notices/issues/111111</a>

            <p>CVE Description 1</p>
            <h1>USN-2874-1: Bind vulnerability</h1>
            <h2><b>Present</b> in rootfs</h2>
            <a href='https://github.com/cloudfoundry/security-notices/issues/333333'>https://github.com/cloudfoundry/security-notices/issues/333333</a>

            <p>CVE Description 2</p>
          BODY
        end

        it 'posts github issues to the correct repos' do
          expect(Octokit).to receive(:create_issue)
             .with('cloudfoundry/security-notices',
                   'USN-2875-1: libxml2 vulnerabilities',
                   "```\nCVE Description 1\n```",
                   labels: [])
          expect(Octokit).to receive(:create_issue)
             .with('cloudfoundry/security-notices',
                   'USN-2874-1: Bind vulnerability',
                   "```\nCVE Description 2\n```",
                   labels: [])
          subject
        end
      end

      context 'that are unrelated to stacks' do
        let(:contents) { { :category => 'cflinuxfs2-unrelated', :labels => ['not-in-rootfs'] } }

        it 'prepares the headers of an email with multiple cves' do
          subject

          headers_content = File.read(File.join(write_directory, 'headers-cflinuxfs2-unrelated'))
          expect(headers_content).to eq(<<~BODY)
            MIME-version: 1.0
            Content-Type: text/html; charset="UTF-8"
          BODY
        end

        it 'prepares the subject of an email with multiple cves' do
          subject

          subject_content = File.read(File.join(write_directory, 'subject-cflinuxfs2-unrelated'))
          expect(subject_content).to eq('New CVEs: USN-2875-1: libxml2 vulnerabilities, USN-2874-1: Bind vulnerability')
        end

        it 'prepares the body of an email with multiple cves' do
          subject

          body_content = File.read(File.join(write_directory, 'body-cflinuxfs2-unrelated'))
          expect(body_content).to eq(<<~BODY)
            <h1>USN-2875-1: libxml2 vulnerabilities</h1>
            <h2><b>Not present</b> in rootfs</h2>
            <a href='https://github.com/cloudfoundry/security-notices/issues/111111'>https://github.com/cloudfoundry/security-notices/issues/111111</a>

            <p>CVE Description 1</p>
            <h1>USN-2874-1: Bind vulnerability</h1>
            <h2><b>Not present</b> in rootfs</h2>
            <a href='https://github.com/cloudfoundry/security-notices/issues/333333'>https://github.com/cloudfoundry/security-notices/issues/333333</a>

            <p>CVE Description 2</p>
          BODY
        end

        it 'posts github issues with label `not-in-rootfs` to the correct repos' do
          expect(Octokit).to receive(:create_issue)
             .with('cloudfoundry/security-notices',
                   'USN-2875-1: libxml2 vulnerabilities',
                   "```\nCVE Description 1\n```",
                   labels: ['not-in-rootfs'])
          expect(Octokit).to receive(:create_issue)
             .with('cloudfoundry/security-notices',
                   'USN-2874-1: Bind vulnerability',
                   "```\nCVE Description 2\n```",
                   labels: ['not-in-rootfs'])

          subject
        end
      end

      context 'that affect a buildpack' do
        let(:contents) { { :category => 'buildpack-ruby', :labels => ['ruby'] } }

        it 'prepares the headers of an email with multiple cves' do
          subject

          headers_content = File.read(File.join(write_directory, 'headers-buildpack-ruby'))
          expect(headers_content).to eq(<<~BODY)
            MIME-version: 1.0
            Content-Type: text/html; charset="UTF-8"
          BODY
        end

        it 'prepares the subject of an email with multiple cves' do
          subject

          subject_content = File.read(File.join(write_directory, 'subject-buildpack-ruby'))
          expect(subject_content).to eq('New CVEs: USN-2875-1: libxml2 vulnerabilities, USN-2874-1: Bind vulnerability')
        end

        it 'prepares the body of an email with multiple cves' do
          subject

          body_content = File.read(File.join(write_directory, 'body-buildpack-ruby'))
          expect(body_content).to eq(<<~BODY)
            <h1>USN-2875-1: libxml2 vulnerabilities</h1>

            <a href='https://github.com/cloudfoundry/security-notices/issues/111111'>https://github.com/cloudfoundry/security-notices/issues/111111</a>

            <p>CVE Description 1</p>
            <h1>USN-2874-1: Bind vulnerability</h1>

            <a href='https://github.com/cloudfoundry/security-notices/issues/333333'>https://github.com/cloudfoundry/security-notices/issues/333333</a>

            <p>CVE Description 2</p>
          BODY
        end

        it 'posts github issues with label `not-in-rootfs` to the correct repos' do
          expect(Octokit).to receive(:create_issue)
             .with('cloudfoundry/security-notices',
                   'USN-2875-1: libxml2 vulnerabilities',
                   "```\nCVE Description 1\n```",
                   labels: ['ruby'])
          expect(Octokit).to receive(:create_issue)
             .with('cloudfoundry/security-notices',
                   'USN-2874-1: Bind vulnerability',
                   "```\nCVE Description 2\n```",
                   labels: ['ruby'])

          subject
        end
      end
    end
  end
end
