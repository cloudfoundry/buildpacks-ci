# encoding: utf-8
require 'spec_helper'
require 'webmock/rspec'
require_relative '../../lib/rootfs-cve-feed'

describe RootFSCVEFeed do
  let(:target_dir) {
    File.expand_path(File.join(File.dirname(__FILE__), '..', 'fixtures', 'cve-notifications', 'stacks'))
  }
  let(:libpng_vulnerability) { 'USN-2815-1: libpng vulnerabilities' }
  let(:libpng_description_fragment) { 'libpng could be made to crash or run programs' }
  let(:libpng_description_html_fragment) { '<p>libpng could be made to crash or run programs' }
  let(:rss_url) { 'https://usn.ubuntu.com/rss.xml' }
  let(:sample_xml) { File.join(File.dirname(__FILE__), '..', 'fixtures', 'cve-notifications', 'sample_cve.xml') }

  before do
    sample_feed = File.open(sample_xml, 'r').read
    stub_request(:get, rss_url).to_return(status: 200, body: sample_feed)
  end

  [
      ['cflinuxfs2', 'Ubuntu 14.04', 'cflinuxfs2/cflinuxfs2_receipt'],
      ['cflinuxfs3', 'Ubuntu 18.04', 'receipt.cflinuxfs3.x86_64'],
      ['cflinuxfs3m', 'Ubuntu 18.04', 'receipt.cflinuxfs3m.x86_64']
  ].each do |data|
    context "when the stack is #{data[0]}" do
      let(:system_name) { data[1] }
      let(:receipt_file) { data[2] }
      subject { described_class.new(data[0], target_dir) }

      context 'and there are CVEs in the given system' do
        context 'but the library was not found in the receipt' do
          before do
            Dir.chdir target_dir do
              File.rename("#{receipt_file}", 'cflinuxfs2/cflinuxfs2_receipt_backup')
              receipt = File.read('cflinuxfs2/cflinuxfs2_receipt_backup')
              receipt = receipt.lines.reject { |l| l.include?('libpng') }.join("\n")
              File.write("#{receipt_file}", receipt)
            end
          end

          after do
            Dir.chdir target_dir do
              File.rename('cflinuxfs2/cflinuxfs2_receipt_backup', "#{receipt_file}")
            end
          end

          describe 'with related cves' do
            it 'should not return libpng' do
              response = subject.related_cves(system_name)
              expect(a_request(:get, 'https://usn.ubuntu.com/rss.xml')).to have_been_made.once
              expect(response.map { |h| h[:title] }).not_to include(libpng_vulnerability)
            end
          end

          describe 'with unrelated cves' do
            it 'should return libpng' do
              response = subject.unrelated_cves(system_name)
              expect(a_request(:get, 'https://usn.ubuntu.com/rss.xml')).to have_been_made.once
              expect(response.map { |h| h['title'] }).to include(libpng_vulnerability)
            end
          end
        end
      end

      context 'and there are no CVEs' do
        let(:sample_xml) { File.join(File.dirname(__FILE__), '..', 'fixtures', 'cve-notifications', 'no_ubuntu1404_cve.xml') }

        describe 'with related cves' do
          it 'should return an empty list of CVEs' do
            response = subject.related_cves(system_name)
            expect(a_request(:get, 'https://usn.ubuntu.com/rss.xml')).to have_been_made.once
            expect(response).to eq []
          end
        end

        describe 'with unrelated cves' do
          it 'should return an empty list of CVEs' do
            response = subject.unrelated_cves(system_name)
            expect(a_request(:get, 'https://usn.ubuntu.com/rss.xml')).to have_been_made.once
            expect(response).to eq []
          end
        end
      end

      describe 'with related cves' do
        context 'and there are CVEs' do
          it 'should return a list of CVEs related to repo' do
            response = subject.related_cves(system_name)
            expect(a_request(:get, 'https://usn.ubuntu.com/rss.xml')).to have_been_made.once
            expect(response.first['title']).to include libpng_vulnerability
            expect(response.first['description']).to include libpng_description_fragment
            expect(response.first['raw_description']).to include libpng_description_html_fragment
          end
        end

        context 'when there is a CVE with multiple dependencies but only one matches' do
          it 'should return that CVE in the list' do
            cves = subject.related_cves(system_name)
            expect(a_request(:get, 'https://usn.ubuntu.com/rss.xml')).to have_been_made.once
            found_cve = cves.find { |cve| cve['title'] == 'USN-2810-1: Kerberos vulnerabilities' }
            expect(found_cve).to_not be_nil
          end
        end

        context 'when no receipt is found' do
          before do
            Dir.chdir target_dir do
              File.rename("#{receipt_file}", 'cflinuxfs2/cflinuxfs2_receipt_backup')
            end
          end

          after do
            Dir.chdir target_dir do
              File.rename('cflinuxfs2/cflinuxfs2_receipt_backup', "#{receipt_file}")
            end
          end

          it 'should raise an error without contacting the RSS feed' do
            expect { subject.related_cves(system_name) }.to raise_error(RuntimeError)
            expect(a_request(:get, 'https://usn.ubuntu.com/rss.xml')).not_to have_been_made
          end
        end

        context 'with an HTTP error' do
          before do
            stub_request(:get, rss_url).to_return(status: [404, 'Page Not Found'])
          end

          it 'should raise an HTTP error' do
            expect { subject.related_cves(system_name) }.to raise_error(OpenURI::HTTPError)
          end
        end
      end
    end
  end
end
