# encoding: utf-8
require 'fileutils'
require 'spec_helper'
require_relative '../../lib/stack-cve-notifier.rb'
require_relative '../../lib/cve-history.rb'

describe StackCVENotifier do
  let(:cves_dir) { Dir.mktmpdir }
  let(:notifier1) { double(:notifier1) }
  let(:notifiers) { [notifier1] }
  let(:history) { CVEHistory.new(cves_dir) }
  let(:cve_history_file) { File.join(cves_dir, 'fakeos.yml') }

  let(:new_cve_rss) { { title: 'USN-9999-1: LibXML Security', description: 'Parses bits improperly' } }
  let(:old_cve_rss) { { title: 'USN-0000-1: linux vulnerability', description: 'kernel crash' } }

  let(:old_cve_yaml) { [{ 'title' => 'USN-0000-1: linux vulnerability', 'stack_release' => '0.9.34' }] }

  let(:related_to_stacks) { true }

  subject { described_class.new(history, cves_dir).run!('fake os', 'fakeos', notifiers) }

  before do
    allow_any_instance_of(CVETags).to receive(:related_cves).and_return([new_cve_rss, old_cve_rss])
    allow_any_instance_of(CVETags).to receive(:unrelated_cves).and_return([])

    notifiers.each { |n| allow(n).to receive(:notify!) }

    allow(GitClient).to receive(:add_everything)
    allow(GitClient).to receive(:safe_commit)

    File.write(cve_history_file, old_cve_yaml.to_yaml)
  end

  shared_examples_for 'uses notifiers and syncs cve yaml' do
    it 'writes the cves to the yaml file' do
      subject

      cves = YAML.load File.read(cve_history_file)
      expect(cves).to eq([{ 'title' => 'USN-9999-1: LibXML Security', 'stack_release' => 'unreleased' },
                          { 'title' => 'USN-0000-1: linux vulnerability', 'stack_release' => '0.9.34' }])
    end

    it 'commits the results' do
      subject
      expect(GitClient).to have_received(:add_everything)
      expect(GitClient).to have_received(:safe_commit).with('CVE update')
    end
  end

  context 'no new CVEs' do
    before do
      allow_any_instance_of(CVETags).to receive(:related_cves).and_return([old_cve_rss])
      allow_any_instance_of(CVETags).to receive(:unrelated_cves).and_return([])
    end

    it 'invokes notifiers no matter what' do
      expect(notifier1).to receive(:notify!).with([], related_to_stacks)
      subject
    end

    it 'does not update the yaml file' do
      subject

      cves = YAML.load File.read(cve_history_file)
      expect(cves).to eq([{ 'title' => 'USN-0000-1: linux vulnerability', 'stack_release' => '0.9.34' }])
    end
  end

  context 'related cves' do
    it_behaves_like 'uses notifiers and syncs cve yaml'
  end

  context 'unrelated cves' do
    let(:related_to_stacks) { false }
    let(:cve_history_file) { File.join(cves_dir, 'fakeos-unrelated.yml') }

    before do
      allow_any_instance_of(CVETags).to receive(:related_cves).and_return([])
      allow_any_instance_of(CVETags).to receive(:unrelated_cves).and_return([new_cve_rss, old_cve_rss])
    end

    it_behaves_like 'uses notifiers and syncs cve yaml'
  end
end
