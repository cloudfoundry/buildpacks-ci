---
name: concourse
director_uuid: <%= concourse_gcp_bosh_director_uuid %>
releases:
- name: concourse
  version: 4.2.1
  url: https://bosh.io/d/github.com/concourse/concourse?v=4.2.1
  sha1: 470a6fdd7cb82fc723d7d78930c7d261ca4a6cb4
- name: garden-runc
  version: 1.16.3
  url: https://bosh.io/d/github.com/cloudfoundry/garden-runc-release?v=1.16.3
  sha1: 2a7c813e7e4d862e19334addf022916fb6b91eb0
- name: windows-tools
  version: 26
  url: https://bosh.io/d/github.com/cloudfoundry-incubator/windows-tools-release?v=26
  sha1: 7b962d804ad2c09f3c49c964c93d878cc2bba1b0
- name: concourse-windows-worker
  version: 4.0.0
  url: https://bosh.io/d/github.com/pivotal-cf-experimental/concourse-windows-worker-release?v=4.0.0
  sha1: 59badb165e81627813d486142ee1748ba8882730
- name: ulimit
  version: latest
  url: https://github.com/pivotal-cf/ulimit-release/releases/download/v1/ulimit.tgz
instance_groups:
- name: web
  instances: 1
  vm_type: web
  azs:
  - z1
  stemcell: trusty
  networks:
  - name: public
    default:
    - dns
    - gateway
  - name: vip
    static_ips:
    - 104.196.174.175
  jobs:
  - name: ulimit
    release: ulimit
    properties:
      nofile:
        soft: 32768
        hard: 32768
  - name: atc
    release: concourse
    properties:
      add_local_users:
      - buildpacks:<%= concourse_basic_auth_password %>
      token_signing_key: ((token_signing_key))
      external_url: https://buildpacks.ci.cf-app.com
      publicly_viewable: true
      main_team:
        auth:
          github:
            teams:
            - cloudfoundry:CF Buildpacks
            users:
            - nebhale
            - slowestgirl
            - sclevine
            - shanks3012
          local:
            users:
            - buildpacks
      github_auth:
        client_id: <%= gcp_concourse_github_auth_client_id %>
        client_secret: <%= gcp_concourse_github_auth_client_secret %>
      postgresql:
        database: <%= gcp_concourse_db_name %>
        role:
          name: <%= gcp_concourse_db_admin_user %>
          password: <%= gcp_concourse_db_admin_password %>
        host: <%= gcp_concourse_db_host %>
        sslmode: disable
      postgresql_database: <%= gcp_concourse_db_name %>
      tls_key: |
        <%= concourse_buildpacks_gcp_key.split("\n").join("\n        ") %>
      tls_cert: |
        <%= concourse_buildpacks_gcp_crt.gsub("\n", "\n        ").chomp  %>
        <%= concourse_buildpacks_gcp_chain.gsub("\n", "\n        ").chomp %>
      tls_bind_port: 443
  - name: tsa
    release: concourse
    properties:
      host_key: ((tsa_host_key))
      token_signing_key: ((token_signing_key))
      authorized_keys:
      - ((worker_key.public_key))
      - "ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQC4S+edcGVNnLSrRHKrXWOKlGVzYDoPgb984IXkBxuVIw4vtS842AQJR1MXzw4RvfPbXMcaOgoU/PKkGXiuw7YmK8MLOZn1a/xFQXJNLtJ+mw5vVgvMd+Uy4YEc6wHPhk9X2nHKw9QtoW4J6z1BzEiP+qUUnbXrBRNFzWCQnFl2jg9ilboqBXpYVJdqLf+1QbpFV9+9qY2MAg9gRqjUn5tUDCCRmE3etYDG/6fm/wrf8X4m0WNDmbTC7J97w+qCqfCyGnLpbjbJxjo+5UM9V9qGe4OGPaz4N/fqfH3JWdGImOrNkpSPhcy1idUdGMaJckuzK6qLac65mHXg8JJqALE9 pivotal@john"
- name: worker
  instances: 12
  vm_type: worker
  azs:
  - z1
  stemcell: trusty
  networks:
  - name: public
  jobs:
  - name: worker
    release: concourse
    consumes: {baggageclaim: {from: worker-baggageclaim}}
    properties:
      tsa_host: 10.150.0.2
      drain_timeout: 10m
      tsa: {worker_key: ((worker_key))}
      tsa_public_key: ((tsa_host_key.public_key))
      tsa_worker_private_key: ((worker_key.private_key))
  - name: baggageclaim
    release: concourse
    provides: {baggageclaim: {as: worker-baggageclaim}}
    properties: {}
  - name: garden
    release: garden-runc
    properties:
      garden:
        listen_network: tcp
        listen_address: 0.0.0.0:7777
        network_mtu: 1432
- name: windows2016_worker
  instances: 1
  vm_type: worker
  azs:
  - z1
  stemcell: windows2016
  networks:
  - name: public
  jobs:
  - name: golang-windows
    release: windows-tools
  - name: git
    release: windows-tools
  - name: ginkgo
    release: windows-tools
  - name: concourse_windows
    release: concourse-windows-worker
    properties:
      concourse_windows:
        tsa_host: 10.150.0.2:2222
        drain_timeout: 10m
        tsa: {worker_key: ((worker_key))}
        tsa_public_key: ((tsa_host_key.public_key))
        tsa_worker_private_key: ((worker_key.private_key))

variables:
- name: token_signing_key
  type: rsa
- name: tsa_host_key
  type: ssh
- name: worker_key
  type: ssh
update:
  canaries: 0
  max_in_flight: 30
  serial: false
  canary_watch_time: 1000-120000
  update_watch_time: 1000-120000
stemcells:
- alias: trusty
  os: ubuntu-trusty
  version: latest
- alias: windows2016
  os: windows2016
  version: latest

