# encoding: utf-8
require_relative 'rootfs-cve-feed'
require_relative "cve-history"

class RootFSCVENotifier < Struct.new(:cves_dir, :stacks_dir)
  def run!(stack, system_name, system_shorthand, notifiers)
    cve_feed = RootFSCVEFeed.new(stack, stacks_dir)
    related_cves = cve_feed.related_cves(system_name)
    unrelated_cves = cve_feed.unrelated_cves(system_name)

    {
        related_cves => "#{system_shorthand}.yml",
        unrelated_cves => "#{system_shorthand}-unrelated.yml"
    }.each do |all_cves, filename|
      next if all_cves.empty?

      past_cves = CVEHistory.read_yaml_cves(cves_dir, filename)
      past_cve_titles = past_cves.map { |cve| cve['title'] }

      all_cve_titles = all_cves.map { |cve| cve['title'] }

      new_cve_titles = all_cve_titles - past_cve_titles
      new_cves = all_cves.select { |cve| new_cve_titles.include? cve['title'] }

      labels = filename.include?('unrelated') ? ['not-in-rootfs'] : []
      relation = filename.include?('unrelated') ? 'unrelated' : 'related'
      contents = { category: "#{stack}-#{relation}", labels: labels }
      notifiers.each { |n| n.notify!(new_cves, contents) }

      next if new_cves.empty?

      cves_without_release = new_cve_titles.map { |title| { 'title' => title, 'stack_release' => 'unreleased' } }

      CVEHistory.write_yaml_cves(cves_without_release | past_cves, cves_dir, filename)
    end
  end
end
