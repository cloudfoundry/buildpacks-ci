# encoding: utf-8
require_relative 'tracker-client'
require_relative 'slack-client'
require_relative 'cve-tags'
require_relative "git-client"

class StackCVENotifier < Struct.new(:cve_history, :cves_dir, :stacks_dir)
  def run!(system_name, system_shorthand, notifiers)
    cve_tags = CVETags.new(stacks_dir)
    related_cves = cve_tags.related_cves(system_name)
    unrelated_cves = cve_tags.unrelated_cves(system_name)

    {
      related_cves => "#{system_shorthand}.yml",
      unrelated_cves => "#{system_shorthand}-unrelated.yml"
    }.each do |cves, filename|
      next if cves.empty?

      old_cves = cve_history.read_yaml_cves(filename)
      old_cve_titles = old_cves.map { |cve| cve['title'] }

      rss_cve_titles = cves.map { |cve| cve[:title] }

      new_cve_titles = rss_cve_titles - old_cve_titles
      new_cves = cves.select { |cve| new_cve_titles.include? cve[:title] }

      notifiers.each { |n| n.notify! new_cves, !filename.include?('unrelated') }

      next if new_cves.empty?

      cves_without_release = new_cve_titles.map { |title| {'title' => title, 'stack_release' => 'unreleased' } }

      cve_history.write_yaml_cves(cves_without_release | old_cves,
                                  File.join(cves_dir, filename)
                                 )

      Dir.chdir(cves_dir) do
        GitClient.add_everything
        GitClient.safe_commit('CVE update')
      end
    end
  end
end
