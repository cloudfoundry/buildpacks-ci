# encoding: utf-8
require 'rss'
require 'nokogiri'
require 'open-uri'

class RootFSCVEFeed
  attr_reader :stack
  attr_reader :stacks_dir

  def initialize(stack, stacks_dir)
    @stack = stack
    @stacks_dir = stacks_dir
  end

  def related_cves(system_name)
    raise "#{@stack} receipt not found in '#{@stacks_dir}'" unless receipt_found
    return [] unless rss

    @related_cves ||= rss.items.select do |item|
      description = Nokogiri::HTML(item.description) { |c| c.options = Nokogiri::XML::ParseOptions::NOBLANKS }
      header = description.css('dt').find { |dt| dt.text.include?(system_name) }

      next unless header
      sibling = header.css('+ dd')
      libs = []

      while sibling
        libs << [
            sibling.css('> a:first-child').text,
            sibling.css('> a:last-child').text
        ]
        sibling = sibling.css('+ dd').first
      end

      libs.any? do |name, _version|
        find_vulnerability_in_receipt(name)
      end
    end.map do |item|
      {
          'title' => item.title.chomp,
          'description' => Nokogiri::HTML(item.description).text.chomp,
          'raw_description' => Nokogiri::HTML(item.description).search('body').first.inner_html
      }
    end
  end

  def unrelated_cves(system_name)
    all_cves(system_name) - related_cves(system_name)
  end

  private

  def all_cves(system_name)
    raise "#{@stack} receipt not found in '#{@stacks_dir}'" unless receipt_found
    return [] unless rss

    rss.items.select do |item|
      description = Nokogiri::HTML(item.description) { |c| c.options = Nokogiri::XML::ParseOptions::NOBLANKS }
      description.css('dt').find { |dt| dt.text.include?(system_name) }
    end.map do |item|
      {
          'title' => item.title.chomp,
          'description' => Nokogiri::HTML(item.description).text.chomp,
          'raw_description' => Nokogiri::HTML(item.description).search('body').first.inner_html
      }
    end
  end

  def feed_uri
    'https://usn.ubuntu.com/rss.xml'
  end

  def rss
    @rss ||= RSS::Parser.parse(open(feed_uri), false)
  end

  def receipt_found
    case @stack
    when 'cflinuxfs2'
      File.exist? "#{@stacks_dir}/cflinuxfs2/cflinuxfs2_receipt"
    when 'cflinuxfs3'
      File.exist? "#{@stacks_dir}/receipt.#{@stack}.x86_64"
    when 'tiny'
      File.exist? "#{@stacks_dir}/packagelist"
    when 'base', 'full-cf', 'full'
      File.exist? "#{@stacks_dir}/stack-image-receipt"
    else
      raise "Unsupported stack #{@stack}"
    end
  end

  def find_vulnerability_in_receipt(name)
    regex = "\\s#{name}(:amd64)*\\s"
    Dir.chdir(@stacks_dir) do
      case @stack
      when 'cflinuxfs2'
        !open('cflinuxfs2/cflinuxfs2_receipt', 'r').grep(/#{regex}/).empty?
      when 'cflinuxfs3'
        !open("receipt.#{@stack}.x86_64", 'r').grep(/#{regex}/).empty?
      when 'tiny'
        !open("packagelist", 'r').grep(/#{name}/).empty?
      when 'base', 'full-cf', 'full'
        !open("stack-image-receipt", 'r').grep(/#{regex}/).empty?
      else
        raise "Unsupported stack #{@stack}"
      end
    end
  end
end
