#!/usr/bin/env ruby

require 'open-uri'
require 'tracker_api'
require 'yaml'

version = File.read('version/number').strip

stack = ENV.fetch('STACK')
github_org = ''
docker_link = ''

if stack == 'cflinuxfs2'
  cve_yaml_file = 'new-cves-artifacts/new-cve-notifications/ubuntu14.04.yml'
  github_org = 'cloudfoundry'
  docker_link = 'Docker: https://hub.docker.com/r/cloudfoundry/cflinuxfs2/tags/'
elsif stack == 'cflinuxfs2-nc'
  cve_yaml_file = 'new-cves-artifacts/new-cves-stacks-nc/ubuntu14.04.yml'
  github_org = 'pivotal-cf'
else
  raise "Unsupported stack: #{stack}"
end

cves = YAML.load_file(cve_yaml_file)

addressed_cves = cves.select { |cve| cve['stack_release'] == version }

exit 0 if addressed_cves.empty?

project_id = ENV.fetch('TRACKER_PROJECT_ID')
requester_id = ENV.fetch('TRACKER_REQUESTER_ID').to_i
api_token = ENV.fetch('TRACKER_API_TOKEN')

client = TrackerApi::Client.new(token: api_token)
buildpack_project = client.project(project_id)

addressed_cves.each do |cve|
  usn = cve['title'].split(':').first
  stories = buildpack_project.stories(filter: "name:\"#{usn}\"")

  if stories.count != 1
    raise "expected 1 story, found #{stories.count}"
  end

  story = stories.first

  comment_body = <<~COMMENT
  ```
  #{stack}

  Story: https://www.pivotaltracker.com/story/show/#{story.id}
  #{stack}: https://github.com/#{github_org}/#{stack}/releases/tag/#{version}
  #{docker_link}
  BOSH: https://github.com/#{github_org}/#{stack}-release/releases/tag/v#{version}
  ```
  COMMENT

  story.create_comment(text: comment_body, person_id: requester_id)
end
