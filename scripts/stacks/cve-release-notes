#!/usr/bin/env ruby
# encoding: utf-8

require 'nokogiri'
require 'open-uri'

usn_url  = ARGV[0]
contents = open(usn_url).read
doc      = Nokogiri::HTML(contents)

usn_id    = doc.css('#main-content > div > div > h1').first.text
usn_title = doc.css('#main-content > div > h2').first.text
cves      = doc.css('#main-content > div > h3:contains("References") + p > a[href*="cve/CVE"]')

notes = "Notably, this release addresses [#{usn_id}](#{usn_url}) #{usn_title}:\n\n"
cves.each do |cve|
  cve_id  = cve.text
  cve_uri = cve['href']
  cve_element = Nokogiri::HTML(open(cve_uri).read).css('#container > div:contains("Description") > div.value').first

  cve_description = cve_element.children.map do |child|
    child.text if child.text?
  end.compact.join(" ")

  notes += "* [#{cve_id}](#{cve_uri}): #{cve_description}\n"
end

puts notes
