#!/bin/bash -l

set -eux
DOMAIN_NAME=${DOMAIN_NAME:-cf-app.com}
IAAS=${IAAS:-aws}
SCRIPT_DIR=$(pwd)/$(dirname $0)

rsync -a deployments-buildpacks/ deployments-buildpacks-artifacts

cd deployments-buildpacks-artifacts
bundle config mirror.https://rubygems.org ${RUBYGEM_MIRROR}
bundle install --jobs=$(nproc) --retry 5
# Add key to ssh-agent
. bin/target_bosh --no-target
export BOSH_LITE_PRIVATE_KEY=$(pwd)/keys/bosh.pem

cd deployments/$DEPLOYMENT_NAME
if [ "$IAAS" = "aws" ]; then
  $SCRIPT_DIR/terminate-bosh-lite
  rm -rf .vagrant

  export VAGRANT_CWD=$(pwd)
  /usr/bin/vagrant up --provider=aws
elif [ "$IAAS" = "azure" ]; then
  # Set up BOSH user and password for Azure BOSH, currently bosh-lite user and password
  BOSH_LITE_USER=$BOSH_USER
  BOSH_LITE_PASSWORD=$BOSH_PASSWORD
  export BOSH_USER=$AZURE_BOSH_DIRECTOR_USER
  export BOSH_PASSWORD=$AZURE_BOSH_DIRECTOR_PASSWORD

  # Clean up and destroy old bosh-lite VM
  BOSH_TARGET=bosh.buildpacks-azure.ci.$DOMAIN_NAME ../../bin/target_bosh concourse-azure
  echo "yes" | bosh delete deployment $AZURE_BOSH_LITE_NAME

  # Boot up new bosh-lite VM
  # Use correct director uuid in bosh-lite manifest
  cp bosh-lite/bosh-lite-template.yml bosh-lite.yml
  sed -i "s|^director_uuid:.*$|director_uuid: $(bosh status --uuid)|" bosh-lite.yml

  bosh deployment bosh-lite.yml
  echo "yes" | bosh deploy

  export BOSH_USER=$BOSH_LITE_USER
  export BOSH_PASSWORD=$BOSH_LITE_PASSWORD
elif [ "$IAAS" = gcp ]; then

  BOSH_LITE_USER=$BOSH_USER
  BOSH_LITE_PASSWORD=$BOSH_PASSWORD
  export BOSH_USER=$GCP_BOSH_DIRECTOR_USER
  export BOSH_PASSWORD=$GCP_BOSH_DIRECTOR_PASSWORD

  # Clean up and destroy old bosh-lite VM
  BOSH_TARGET="bosh.buildpacks-gcp.ci.$DOMAIN_NAME" ../../bin/target_bosh concourse-gcp
  echo "yes" | bosh delete deployment $GCP_BOSH_LITE_NAME

  # Boot up new bosh-lite VM
  # Use correct director uuid in bosh-lite manifest
  cp bosh-lite/bosh-lite-template.yml bosh-lite.yml
  sed -i "s|^director_uuid:.*$|director_uuid: $(bosh status --uuid)|" bosh-lite.yml

  bosh deployment bosh-lite.yml
  echo "yes" | bosh deploy

  export BOSH_USER=$BOSH_LITE_USER
  export BOSH_PASSWORD=$BOSH_LITE_PASSWORD
else
  echo "Please specify IAAS=(aws|azure|gcp)"
  exit 1
fi

# Commit AWS artifacts
git add -A
git commit -m "recreated deployment $DEPLOYMENT_NAME"

until $(curl -k --output /dev/null --silent --head --fail https://$DEPLOYMENT_NAME.$DOMAIN_NAME:25555/info); do
    printf '.'
    sleep 10
done

# Destroy deployment if we are not able to connect and update the user
# Updates admin user's password from admin to our specified password
if bosh -u admin -p admin -t $DEPLOYMENT_NAME.$DOMAIN_NAME create user admin $PASSWORD; then
  echo "Deployment working!"
else
  if [ "$IAAS" = "aws" ]; then
    echo "Deployment failed: deleting instance"
    $SCRIPT_DIR/terminate-bosh-lite
    rm -rf .vagrant
    exit 1
  fi
fi

# Remove deployment manifests generated from the previous recreation cycle
# So this recreation cycle's manifest generation is fresh
if test -n "$(find . -maxdepth 1 -name '*.yml' -print -quit)"; then
  rm -f *.yml
  git add -A
  git commit -m "remove deployment manifests for $DEPLOYMENT_NAME"
fi
