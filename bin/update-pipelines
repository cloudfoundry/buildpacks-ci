#!/usr/bin/env bash

set -euo pipefail

MY_DIR="$(cd "$(dirname "$0")" && pwd)"
REPO_ROOT="$(cd "${MY_DIR}/.." && pwd)"
target="buildpacks"
team="buildpacks-team"
pipeline_filter=""
list_mode=false
buildpacks_only_mode=false
all_mode=false
dry_run_flag=""
non_interactive_flag=""

login() {
  fly -t "$target" login -n "${team}" -b
}

check_login_status() {
  current_team="$(yq e .targets.buildpacks.team ~/.flyrc)"
  if [[ "${current_team}" != "${team}" ]]; then
    login
  fi

  fly -t "$target" status >/dev/null 2>&1 || login
}

get_ytt_buildpack_names() {
  # Returns a list of buildpack pipeline names that have YTT versions
  local buildpack_dir="$REPO_ROOT/pipelines/buildpack"
  if [[ -d "$buildpack_dir" ]]; then
    for values_file in "$buildpack_dir"/*-values.yml; do
      if [[ -f "$values_file" ]]; then
        language="$(basename "${values_file%-values.yml}")"
        echo "${language}-buildpack"
      fi
    done
  fi
}

list_pipelines() {
  echo "Available pipelines:"
  for pipeline_path in "$REPO_ROOT"/pipelines/*; do
    if [[ -d "$pipeline_path" ]]; then
      pipeline_name="$(basename "$pipeline_path")"
      if [[ "$pipeline_name" == "config" || "$pipeline_name" == "templates" ]]; then
        continue
      fi
      
      # Special handling for buildpack directory with multiple value files
      if [[ "$pipeline_name" == "buildpack" ]]; then
        for values_file in "$pipeline_path"/*-values.yml; do
          if [[ -f "$values_file" ]]; then
            language="$(basename "${values_file%-values.yml}")"
            echo "  - ${language}-buildpack"
          fi
        done
      else
        echo "  - $pipeline_name"
      fi
    elif [[ -f "$pipeline_path" ]]; then
      pipeline_name="$(basename "${pipeline_path%.yml}")"
      if [[ "$pipeline_name" == "cflinuxfs4" || "$pipeline_name" == "cflinuxfs5" ]]; then
        echo "  - $pipeline_name"
      fi
    fi
  done
  echo ""
}

show_help() {
  list_pipelines
  echo "Usage: ./bin/update-pipelines [OPTIONS]"
  echo ""
  echo "Options:"
  echo "  --all, -a                   Update all pipelines"
  echo "  --pipeline=NAME, -p NAME    Update specific pipeline"
  echo "  --buildpacks-only, -b       Update all buildpack pipelines only"
  echo "  --list, -l                  List all available pipelines"
  echo "  --dry-run, -d               Validate pipeline without applying changes"
  echo "  --non-interactive, -n       Skip all confirmation prompts"
  echo ""
}

process_pipelines() {
  local filter="$1"
  
  for pipeline_path in "$REPO_ROOT"/pipelines/*; do
    if [[ -d "$pipeline_path" ]]; then
      pipeline_name="$(basename "$pipeline_path")"
      if [[ "$pipeline_name" == "config" || "$pipeline_name" == "templates" ]]; then
        continue
      fi
      
      # Special handling for buildpack directory with multiple value files
      if [[ "$pipeline_name" == "buildpack" ]]; then
        for values_file in "$pipeline_path"/*-values.yml; do
          if [[ ! -f "$values_file" ]]; then
            continue
          fi
          
          language="$(basename "${values_file%-values.yml}")"
          buildpack_pipeline_name="${language}-buildpack"
          
          # Skip if buildpacks-only mode is active (process all buildpacks)
          # or if filter is set and doesn't match
          if [[ "$buildpacks_only_mode" == false && -n "$filter" && "$buildpack_pipeline_name" != "$filter" ]]; then
            continue
          fi

          echo "Setting $buildpack_pipeline_name"
          pipeline_config="$(ytt -f "$pipeline_path/pipeline.yml" -f "$pipeline_path/config.yml" -f "$values_file")"
          fly -t "$target" set-pipeline -p "$buildpack_pipeline_name" $dry_run_flag $non_interactive_flag -c <(echo "$pipeline_config")
        done
      else
        # Skip non-buildpack pipelines if buildpacks-only mode is active
        if [[ "$buildpacks_only_mode" == true ]]; then
          continue
        fi
        
        if [[ -n "$filter" && "$pipeline_name" != "$filter" ]]; then
          continue
        fi

        echo "Setting $pipeline_name"
        pipeline_config="$(ytt -f "$pipeline_path")"
        fly -t "$target" set-pipeline -p "$pipeline_name" $dry_run_flag $non_interactive_flag -c <(echo "$pipeline_config")
      fi
      
    elif [[ -f "$pipeline_path" ]]; then
      # Skip file-based pipelines if buildpacks-only mode is active
      if [[ "$buildpacks_only_mode" == true ]]; then
        continue
      fi
      
      pipeline_name="$(basename "${pipeline_path%.yml}")"
      if [[ "$pipeline_name" != "cflinuxfs4" && "$pipeline_name" != "cflinuxfs5" ]]; then
        continue
      fi
      
      if [[ -n "$filter" && "$pipeline_name" != "$filter" ]]; then
        continue
      fi

      echo "Setting $pipeline_name"
      pipeline_config="$(ytt -f "$pipeline_path")"
      fly -t "$target" set-pipeline -p "$pipeline_name" $dry_run_flag $non_interactive_flag -c <(echo "$pipeline_config")
    fi
  done
}

parse_args() {
  while [[ $# -gt 0 ]]; do
    case $1 in
      --pipeline=*)
        pipeline_filter="${1#*=}"
        shift
        ;;
      --pipeline|-p)
        pipeline_filter="$2"
        shift 2
        ;;
      --list|-l)
        list_mode=true
        shift
        ;;
      --buildpacks-only|-b)
        buildpacks_only_mode=true
        shift
        ;;
      --all|-a)
        all_mode=true
        shift
        ;;
      --dry-run|-d)
        dry_run_flag="--dry-run"
        shift
        ;;
      --non-interactive|-n)
        non_interactive_flag="--non-interactive"
        shift
        ;;
      *)
        shift
        ;;
    esac
  done
}

main() {
  parse_args "$@"

  if [[ "$list_mode" == true ]]; then
    show_help
    return
  fi

  # Show help if no action flags are provided
  if [[ "$all_mode" == false && "$buildpacks_only_mode" == false && -z "$pipeline_filter" ]]; then
    show_help
    return
  fi

  if [[ -z "$dry_run_flag" ]]; then
    check_login_status
  fi
  
  process_pipelines "$pipeline_filter"
  
  echo ""
  echo "Thanks, The Buildpacks Team"
}

main "$@"
